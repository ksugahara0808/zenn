---
title: "AWS WAFV2ã®ãƒ­ã‚°ã‚’è¦‹ã‚‹ã¨ãã«ã‚ˆãä½¿ã†ã‚¯ã‚¨ãƒªé›†"
emoji: "ğŸ"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["WAF", "Athena"]
published: true
---

ğŸæ˜ã‘ã¾ã—ã¦ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ğŸ
ä»Šå¹´ã‚‚ã‚ˆã‚ã—ããŠé¡˜ã„ã—ã¾ã™ã€‚

ä»Šå›ã¯AWS WAFV2ã®èª¿æŸ»ã®ã¨ãã«ã‚ˆãä½¿ã†ã‚¯ã‚¨ãƒªã‚’ç´¹ä»‹ã—ã¾ã™ã€‚
WAFV2ã‚’é‹ç”¨ã«è¼‰ã›ãŸã‚Šã€èª¿æŸ»ã™ã‚‹ã¨ãAmazon Athenaã§åˆ©ç”¨ã™ã‚‹ã‚¯ã‚¨ãƒªã§ã™ã€‚

# å‰æ
ã“ã®è¨˜äº‹ã®å‰æã¯ä»¥ä¸‹ã«ãªã‚Šã¾ã™ã€‚
- AWS WAFV2ã‚’ä½¿ã£ã¦ã„ã‚‹ã“ã¨
- AWS WAFV2ã®ãƒ­ã‚°ã‚’S3ã«ä¿å­˜ã—ã¦ã„ã‚‹ã“ã¨
- AWSå…¬å¼ã®AWS Glueãƒ†ãƒ¼ãƒ–ãƒ«è¨­å®šã‚’ã—ã¦ã„ã‚‹ã“ã¨

## è¨­å®š
ã¡ã‚‡ã£ã¨è„±ç·šã™ã‚‹ã®ã§ã™ãŒã€Glueã«å…¥ã‚Œã¦ã„ã‚‹å…¬å¼ã®è¨­å®šã‚„ã‚¯ã‚¨ãƒªã¯[ã“ã¡ã‚‰](https://docs.aws.amazon.com/ja_jp/athena/latest/ug/waf-logs.html)ã‚’åˆ©ç”¨ã—ã¦ã„ã¾ã™ã€‚
```sql
CREATE EXTERNAL TABLE `waf_logs`(
  `timestamp` bigint,
  `formatversion` int,
  `webaclid` string,
  `terminatingruleid` string,
  `terminatingruletype` string,
  `action` string,
  `terminatingrulematchdetails` array<
                                  struct<
                                    conditiontype:string,
                                    location:string,
                                    matcheddata:array<string>
                                        >
                                     >,
  `httpsourcename` string,
  `httpsourceid` string,
  `rulegrouplist` array<
                     struct<
                        rulegroupid:string,
                        terminatingrule:struct<
                           ruleid:string,
                           action:string,
                           rulematchdetails:string
                                               >,
                        nonterminatingmatchingrules:array<
                                                       struct<
                                                          ruleid:string,
                                                          action:string,
                                                          rulematchdetails:array<
                                                               struct<
                                                                  conditiontype:string,
                                                                  location:string,
                                                                  matcheddata:array<string>
                                                                     >
                                                                  >
                                                               >
                                                            >,
                        excludedrules:array<
                                         struct<
                                            ruleid:string,
                                            exclusiontype:string
                                               >
                                            >
                           >
                       >,
  `ratebasedrulelist` array<
                        struct<
                          ratebasedruleid:string,
                          limitkey:string,
                          maxrateallowed:int
                              >
                           >,
  `nonterminatingmatchingrules` array<
                                  struct<
                                    ruleid:string,
                                    action:string
                                        >
                                     >,
  `requestheadersinserted` string,
  `responsecodesent` string,
  `httprequest` struct<
                      clientip:string,
                      country:string,
                      headers:array<
                                struct<
                                  name:string,
                                  value:string
                                      >
                                   >,
                      uri:string,
                      args:string,
                      httpversion:string,
                      httpmethod:string,
                      requestid:string
                      >,
  `labels` array<
             struct<
               name:string
                   >
                  >
)
ROW FORMAT SERDE 'org.openx.data.jsonserde.JsonSerDe'
WITH SERDEPROPERTIES (
 'paths'='action,formatVersion,httpRequest,httpSourceId,httpSourceName,labels,nonTerminatingMatchingRules,rateBasedRuleList,requestHeadersInserted,responseCodeSent,ruleGroupList,terminatingRuleId,terminatingRuleMatchDetails,terminatingRuleType,timestamp,webaclId')
STORED AS INPUTFORMAT 'org.apache.hadoop.mapred.TextInputFormat'
OUTPUTFORMAT 'org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat'
LOCATION 's3://athenawaflogs/WebACL/'
```

ã¡ã‚‡ã£ã¨ã‚¢ãƒ¬ãƒ³ã‚¸å…¥ã£ã¦ã„ã‚‹ã®ã§ã™ãŒã€Terraformã§æ›¸ã„ãŸä¾‹ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚
```tf
resource "aws_s3_bucket" "waf_log_bucket" {
  # bucketåãŒ'aws-waf-logs-'ã‹ã‚‰å§‹ã¾ã‚‰ãªã„ã¨ã„ã‘ãªã„
  bucket = "aws-waf-logs-waf-log"
  acl    = "private"

  lifecycle_rule {
    id      = "15months-lifecycle-rule"
    enabled = true

    expiration {
      days = 456
    }
  }
}

resource "aws_s3_bucket_public_access_block" "waf_log" {
  bucket                  = aws_s3_bucket.waf_log_bucket.id
  block_public_acls       = true
  block_public_policy     = true
  ignore_public_acls      = true
  restrict_public_buckets = true
}

resource "aws_glue_catalog_database" "log_catalog_database" {
  name = "waf-log"
}

resource "aws_glue_catalog_table" "waf_log" {
  database_name = aws_glue_catalog_database.log_catalog_database.name
  name          = "waf_log"
  parameters = {
    "EXTERNAL"                     = "TRUE"
    "projection.enabled"           = "true"
    "projection.day.type"          = "date"
    "projection.day.range"         = "2022/01/01/00,NOW"
    "projection.day.format"        = "yyyy/MM/dd/HH"
    "projection.day.interval"      = "1"
    "projection.day.interval.unit" = "HOURS"
    "storage.location.template"    = "s3://aws_s3_bucket.waf_log_bucket.name/AWSLogs/xxxxxxxxxx/WAFLogs/ap-northeast-1/waf-test/$${day}"
  }
  table_type = "EXTERNAL_TABLE"

  partition_keys {
    name = "day"
    type = "string"
  }

  storage_descriptor {
    location      = "s3://aws_s3_bucket.waf_log_bucket.name/AWSLogs/xxxxxxxxxx/WAFLogs/ap-northeast-1/waf-test/"
    compressed    = "true"
    input_format  = "org.apache.hadoop.mapred.TextInputFormat"
    output_format = "org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat"

    columns {
      name = "timestamp"
      type = "bigint"
    }
    columns {
      name = "formatversion"
      type = "int"
    }
    columns {
      name = "webaclid"
      type = "string"
    }
    columns {
      name = "terminatingruleid"
      type = "string"
    }
    columns {
      name = "terminatingruletype"
      type = "string"
    }
    columns {
      name = "action"
      type = "string"
    }
    columns {
      name = "terminatingrulematchdetails"
      type = "array<struct<conditionType:string,location:string,matchedData:array<string>>>"
    }
    columns {
      name = "httpsourcename"
      type = "string"
    }
    columns {
      name = "httpsourceid"
      type = "string"
    }
    columns {
      name = "rulegrouplist"
      type = "array<struct<ruleGroupId:string,terminatingRule:struct<ruleId:string,action:string,ruleMatchDetails:string>,nonTerminatingMatchingRules:array<struct<ruleId:string,action:string,ruleMatchDetails:array<struct<conditionType:string,location:string,matchedData:array<string>>>>>,excludedRules:string>>"
    }
    columns {
      name = "ratebasedrulelist"
      type = "array<struct<rateBasedRuleId:string,limitKey:string,maxRateAllowed:int>>"
    }
    columns {
      name = "nonterminatingmatchingrules"
      type = "array<struct<ruleId:string,action:string>>"
    }
    columns {
      name = "requestheadersinserted"
      type = "string"
    }
    columns {
      name = "responsecodesent"
      type = "string"
    }
    columns {
      name = "httprequest"
      type = "struct<clientIp:string,country:string,headers:array<struct<name:string,value:string>>,uri:string,args:string,httpVersion:string,httpMethod:string,requestId:string>"
    }
    columns {
      name = "labels"
      type = "array<struct<name:string>>"
    }

    ser_de_info {
      name = "JsonSerDe"
      parameters = {
        "serialization.format" = "1"
      }
      serialization_library = "org.openx.data.jsonserde.JsonSerDe"
    }
  }
}
```

partitionç­‰ã¯è‡ªç”±ã«å…¥ã‚Œã¦é ‚ã„ã¦å•é¡Œãªã„ã§ã™ã€‚ã‚¯ã‚¨ãƒªã‚’é©å®œå¤‰æ›´ã—ã¦ãã ã•ã„ã€‚

# ã‚ˆãä½¿ã†ã‚¯ã‚¨ãƒªé›†
## ã¨ã‚Šã‚ãˆãšä¸€è¦§ã‚’ã¿ã‚‹
```sql
SELECT from_unixtime(timestamp/1000, 'Asia/Tokyo') AS JST, *
FROM waf_log
WHERE day >= '2022/01/01/01' AND day <= '2021/01/01/23';
```

## BLOCKã•ã‚ŒãŸã‚‚ã®ã‚’ã¿ã‚‹
```sql
SELECT from_unixtime(timestamp/1000, 'Asia/Tokyo') AS JST, *
FROM waf_log
WHERE day >= '2022/01/01/01' AND day <= '2021/01/01/23'
AND action = 'BLOCK';
```
BLOCKã•ã‚Œã¦ã‚‚ã®ã‚’è¦‹ã‚‹ã¨ãã¯`terminatingrulematchdetails`ã§BLOCKã•ã‚ŒãŸç†ç”±ã‚’ã¿ã¦æ¨æ¸¬ã‚’ã¯ã˜ã‚ã¾ã™ã€‚
`httprequest`ã§é‹è‰¯ãã‚ã‹ã‚‹ã“ã¨ã‚‚ã‚ã‚Œã°ã€APIã®Logã‚’è¦‹ã«è¡Œã£ãŸã‚Šã—ã¾ã™ã€‚

## BLOCKã•ã‚ŒãŸã‚‚ã®ãªãŠã‹ã¤ç‰¹å®šã®URIã§çµã‚‹
```sql
SELECT from_unixtime(timestamp/1000, 'Asia/Tokyo') AS JST, *
FROM waf_log
WHERE httpRequest.uri = '/index.php'
AND day >= '2022/01/01/01' AND day <= '2021/01/01/23'
AND action = 'BLOCK'
ORDER BY timestamp;
```

## BLOCKã•ã‚ŒãŸã‚‚ã®ãªãŠã‹ã¤ç‰¹å®šã®IPã§çµã‚‹
```sql
SELECT from_unixtime(timestamp/1000, 'Asia/Tokyo') AS JST, *
FROM waf_log
WHERE httprequest.clientip = '153.242.5.8'
AND day >= '2022/01/01/01' AND day <= '2021/01/01/23'
AND action = 'BLOCK'
ORDER BY timestamp;
```

## BLOCKã•ã‚ŒãŸã‚‚ã®ãªãŠã‹ã¤ç‰¹å®šã®ãƒ«ãƒ¼ãƒ«ã§çµã‚‹
```sql
SELECT from_unixtime(timestamp/1000, 'Asia/Tokyo') AS JST, *, groupList.terminatingRule.ruleId
FROM waf_log, UNNEST(ruleGroupList) t(groupList)
WHERE groupList.terminatingRule.ruleId = 'SQLi_BODY'
AND day >= '2022/01/01/01' AND day <= '2021/01/01/23'
AND action = 'BLOCK'
ORDER BY timestamp;
```

## XSS/SQLiã®è©³ç´°ãƒ­ã‚°ã‚’å‡ºåŠ›ã™ã‚‹
```sql
SELECT
  from_unixtime(timestamp/1000, 'Asia/Tokyo') AS JST,
  groupList.ruleGroupId,
  groupList.terminatingRule.ruleId,
  ruleMatchDetails.conditionType,
  ruleMatchDetails.location,
  ruleMatchDetails.matchedData,
  httpRequest
FROM
  waf_log,
  UNNEST(terminatingRuleMatchDetails) t(ruleMatchDetails),
  UNNEST(ruleGroupList) t(groupList)
WHERE action = 'BLOCK' and groupList.terminatingRule.action = 'BLOCK'
AND day >= '2022/01/01/01' AND day <= '2021/01/01/23'
ORDER BY timestamp;
```

# é‹ç”¨å‰ã®ãƒã‚§ãƒƒã‚¯ã§ä½¿ã†ã‚¯ã‚¨ãƒª
## COUNTã•ã‚ŒãŸã‚‚ã®ã‚’ã¿ã‚‹
COUNTã¯`action`ã§ã¯ãªã`nonTerminatingMatchingRules`ã«å‡ºã¦ãã‚‹ã®ã§æ³¨æ„ã€‚
```sql
SELECT from_unixtime(timestamp/1000, 'Asia/Tokyo') AS JST, *
FROM waf_log, UNNEST(nonTerminatingMatchingRules) t(nonTermRule)
WHERE nonTermRule.action = 'COUNT' AND day >= '2022/01/01/01' AND day <= '2021/01/01/23'
ORDER BY timestamp;
```

## COUNTã•ã‚ŒãŸä¸Šä½100ã®ãƒ«ãƒ¼ãƒ«ã‚’å–å¾—ã™ã‚‹
```sql
SELECT COUNT(groupList.terminatingRule.ruleId) AS count, groupList.terminatingRule.ruleId
FROM waf_log, UNNEST(nonTerminatingMatchingRules) t(nonTermRule), UNNEST(ruleGroupList) t(groupList)
WHERE nonTermRule.action = 'COUNT' AND day >= '2022/01/01/01' AND day <= '2021/01/01/23'
GROUP BY groupList.terminatingRule.ruleId
ORDER BY count DESC
LIMIT 100;
```

## COUNTã•ã‚ŒãŸä¸Šä½100ã®ãƒ«ãƒ¼ãƒ«ã¨URIã‚’å–å¾—ã™ã‚‹
```sql
SELECT COUNT(groupList.terminatingRule.ruleId) AS count, httpRequest.uri, groupList.terminatingRule.ruleId
FROM waf_log, UNNEST(nonTerminatingMatchingRules) t(nonTermRule), UNNEST(ruleGroupList) t(groupList)
WHERE nonTermRule.action = 'COUNT' AND day >= '2022/01/01/01' AND day <= '2021/01/01/23'
GROUP BY httpRequest.uri, groupList.terminatingRule.ruleId
ORDER BY count DESC
LIMIT 100;
```

## BLOCKã•ã‚ŒãŸä¸Šä½100ã®ãƒ«ãƒ¼ãƒ«ã¨URIã‚’å–å¾—ã™ã‚‹
```sql
SELECT COUNT(groupList.terminatingRule.ruleId) AS count, httpRequest.uri, groupList.terminatingRule.ruleId
FROM waf_log, UNNEST(ruleGroupList) t(groupList)
WHERE action = 'BLOCK' AND day >= '2022/01/01/01' AND day <= '2021/01/01/23'
GROUP BY httpRequest.uri, groupList.terminatingRule.ruleId
ORDER BY count DESC
LIMIT 100;
```

# é‹ç”¨é–‹å§‹å¾Œã®ç¢ºèªã§ä½¿ã†ã‚¯ã‚¨ãƒª
## 1é€±é–“ã§BLOCKã•ã‚ŒãŸURIã¨ãƒ«ãƒ¼ãƒ«ã®Top100
```sql
SELECT COUNT(groupList.terminatingRule.ruleId) AS count, httpRequest.uri, groupList.terminatingRule.ruleId
FROM waf_log, UNNEST(ruleGroupList) t(groupList)
WHERE
  "action" = 'BLOCK' AND
  timestamp >= TO_UNIXTIME(cast(CURRENT_DATE as TIMESTAMP) - interval '7' day) * 1000
GROUP BY httpRequest.uri, groupList.terminatingRule.ruleId
ORDER BY count DESC
LIMIT 100;
```

## BLOCKã•ã‚ŒãŸä¸Šä½100ã®IPã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å–å¾—ã™ã‚‹
```sql
SELECT "httprequest"."clientip", "count"(*) "ipcount", "httprequest"."country"
FROM waf_log
WHERE "action" = 'BLOCK' AND day >= '2022/01/01/01' AND day <= '2021/01/01/23'
GROUP BY "httprequest"."clientip", "httprequest"."country"
ORDER BY "ipcount" DESC
LIMIT 100;
```

# ãŸã¾ã«ä½¿ã†ã‚¯ã‚¨ãƒªé›†
## AWSManagedIPReputationListã§BLOCKã•ã‚ŒãŸIPã‚¢ãƒ‰ãƒ¬ã‚¹ã®ã‚«ã‚¦ãƒ³ãƒˆ
```sql
SELECT "httprequest"."clientip", "count"(*) "ipcount", "httprequest"."country", groupList.terminatingRule.ruleId
FROM waf_log, UNNEST(ruleGroupList) t(groupList)
WHERE "action" = 'BLOCK' AND day >= '2022/01/01/01' AND day <= '2021/01/01/23' AND groupList.terminatingRule.ruleId = 'AWSManagedIPReputationList'
GROUP BY "httprequest"."clientip", "httprequest"."country", groupList.terminatingRule.ruleId
ORDER BY "ipcount" DESC
LIMIT 100;
```

## æŒ‡å®šã•ã‚ŒãŸç”¨èª(ä»Šå›ã¯hogehoge.jp)ã‚’å«ã‚€ãƒªãƒ•ã‚¡ãƒ©ãƒ¼ã®æ•°ã‚’æ•°ãˆã‚‹
```sql
WITH DATASET AS 
  (SELECT header FROM waf_log
    CROSS JOIN UNNEST(httprequest.headers) AS t(header)
    WHERE day >= '2022/01/01/01' AND day <= '2021/01/01/23')
SELECT COUNT(*) referer_count 
FROM DATASET 
WHERE LOWER(header.name)='referer' AND header.value LIKE '%hogehoge.jp%';
```

## éå»10æ—¥é–“ã«é™¤å¤–ãƒ«ãƒ¼ãƒ«ã«ä¸€è‡´ã—ãŸã™ã¹ã¦ã®ä¸€è‡´ã—ãŸIPã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ã‚«ã‚¦ãƒ³ãƒˆã™ã‚‹
```sql
WITH dataset AS 
  (SELECT * FROM waf_log
    CROSS JOIN UNNEST(ruleGroupList) AS t(allRuleGroups))
SELECT COUNT(*) AS
  count, 
  "httpRequest"."clientIp", 
  "allRuleGroups"."excludedRules",
  "allRuleGroups"."ruleGroupId"
FROM dataset 
WHERE allRuleGroups.excludedRules IS NOT NULL AND from_unixtime(timestamp/1000, 'Asia/Tokyo') > now() - interval '10' day
GROUP BY "httpRequest"."clientIp", "allRuleGroups"."ruleGroupId", "allRuleGroups"."excludedRules"
ORDER BY count DESC;
```

## æŒ‡å®šã—ãŸè¦å‰‡ã®ç¨®é¡ã«ã‚ˆã£ã¦BLOCKã•ã‚ŒãŸä¸Šä½100å€‹ã®IPã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’æŠ½å‡ºã™ã‚‹
```sql
SELECT COUNT(httpRequest.clientIp) as count,
httpRequest.clientIp
FROM waf_log, UNNEST(nonTerminatingMatchingRules) t(nonTermRule)
WHERE nonTermRule.ruleid='AWS-AWSManagedRulesCommonRuleSet' AND day >= '2021/12/01/07' AND day <= '2021/12/01/08' AND action='BLOCK'
GROUP BY httpRequest.clientIp
ORDER BY count DESC
LIMIT 100;
```

## æ—¥æœ¬ã‹ã‚‰æ¥ã¦ã„ã¦BLOCKã•ã‚ŒãŸãƒ­ã‚°
```sql
SELECT from_unixtime(timestamp/1000, 'Asia/Tokyo') AS JST, *
FROM waf_log
WHERE httpRequest.country = 'JP' AND action = 'BLOCK'
AND day >= '2021/12/01/07' AND day <= '2021/12/01/08'
ORDER BY timestamp;
```

## å›½æ¯ã®ãƒ­ã‚°æ•°ã®é›†è¨ˆ
```sql
SELECT httpRequest.country, COUNT(httpRequest.country) AS count, day
FROM waf_log
WHERE day >= '2021/12/01/07' AND day <= '2021/12/01/08'
GROUP BY httpRequest.country
ORDER BY count DESC;
```

## ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚ŒãŸå›æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆã—ã€ç‰¹å®šã®å±æ€§ã§ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã™ã‚‹
```sql
SELECT COUNT(*) AS
  count,
  webaclid,
  terminatingruleid,
  httprequest.clientip,
  httprequest.uri
FROM waf_log
WHERE action='BLOCK' AND day >= '2021/12/01/07' AND day <= '2021/12/01/08'
GROUP BY webaclid, terminatingruleid, httprequest.clientip, httprequest.uri
ORDER BY count DESC
LIMIT 100;
```

ä»–ã«ã‚‚ã‚ã£ãŸæ°—ãŒã™ã‚‹ã‘ã‚Œã©ã€æ€ã„å‡ºã—ãŸã‚‰è¿½è¨˜ã—ã¾ã™ã€‚

# æœ€å¾Œã«
AWS WAFV2é‹ç”¨ã§ã‚ˆãä½¿ã£ã¦ã„ã‚‹ã‚¯ã‚¨ãƒªã‚’ç´¹ä»‹ã—ã¾ã—ãŸã€‚
ã‚‚ã—ã“ã‚Œä¾¿åˆ©ã ã‚ˆã¨ã„ã†ã‚¯ã‚¨ãƒªã‚ã‚Œã°æ•™ãˆã¦ãã ã•ã„ã€‚

ã“ã®è¨˜äº‹ãŒã©ãªãŸã‹ã®å½¹ã«ç«‹ã¦ã‚Œã°å¬‰ã—ã„ã§ã™ã€‚